# CPG Explorer - Solution Write-up

## Overview

CPG Explorer is a web-based IDE for exploring Go codebases through their Code Property Graph. The application provides an interactive graph visualization focused on **Call Graph exploration**, allowing developers to understand function relationships, trace call chains, and view source code with metrics and findings.

## Architecture

### Tech Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| **Backend** | Go 1.25 + Gorilla Mux | Native SQLite support, high performance, matches the CPG generator language |
| **Frontend** | Next.js 16 + TypeScript | Modern React framework with SSR, App Router for fast navigation |
| **Graph Viz** | Cytoscape.js + dagre | Mature graph library with excellent performance on 100+ nodes, automatic layout algorithms |
| **Styling** | Tailwind CSS | Rapid UI development, consistent dark theme |
| **Database** | SQLite (read-only) | Directly uses the CPG database generated by cpg-gen |

### System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Browser                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Next.js Frontend (:3000)                │    │
│  │  ┌──────────┐  ┌──────────────┐  ┌─────────────┐    │    │
│  │  │ Sidebar  │  │  GraphView   │  │ SourceView  │    │    │
│  │  │ Hotspots │  │ (Cytoscape)  │  │  Metrics    │    │    │
│  │  │ Packages │  │ Zoom Controls│  │  Findings   │    │    │
│  │  └──────────┘  └──────────────┘  └─────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/JSON
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Go Backend (:5050)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Handlers   │──│   Queries   │──│  SQLite (cpg.db)    │  │
│  │  REST API   │  │   BFS/DFS   │  │  ~900MB, read-only  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Key Features

### 1. Call Graph Explorer (Primary Feature)

- **BFS Traversal**: Explores function call relationships up to configurable depth (1-5 levels)
- **Bidirectional Navigation**: View both callees (what this function calls) and callers (what calls this function)
- **Interactive Nodes**: Click to select, double-click to navigate into a function's neighborhood
- **Focused Subgraphs**: Limited to 60 nodes per view for performance and readability
- **Zoom Controls**: Zoom in/out buttons, fit-to-view, center graph, zoom level percentage indicator

### 2. Hotspots Panel (Schema Exploration)

- **Top Problematic Functions**: Ranked by score = complexity×2 + fan_in + fan_out
- **Color-Coded Severity**: Visual indicators for high-complexity functions
- **Quick Navigation**: Click any hotspot to explore its call graph
- Uses `dashboard_hotspots` table or computes from `metrics` table as fallback

### 3. Function Metrics & Findings

- **Metrics Display**: Cyclomatic complexity (color-coded), LOC, parameters, fan-in, fan-out
- **Findings Integration**: Shows warnings/issues from `findings` table
- **Severity Badges**: Critical/High (red), Medium (orange), Low (yellow)

### 4. Package Browser

- Hierarchical list of all packages in the codebase
- Expandable to show functions within each package
- Quick filter for package search
- Shows function count per package

### 5. Source Code Viewer

- Syntax-highlighted Go code (via Prism)
- Line highlighting for selected function
- File path and line number display
- Integrated with graph selection

### 6. Global Search

- Fuzzy search across functions, methods, and types
- Full-text code search using FTS5
- Real-time results with debouncing
- Direct navigation to search results

### 7. UI/UX Enhancements

- **Toast Notifications**: Error feedback with auto-dismiss
- **Loading States**: Spinners during data fetch and graph initialization
- **Performance Optimization**: useDeferredValue, startTransition, requestAnimationFrame for smooth UI

## Design Decisions

### Why Go Backend?

1. **Performance**: Direct SQLite access without ORM overhead
2. **Consistency**: Same language as the CPG generator
3. **Simplicity**: Single binary deployment, minimal dependencies
4. **Memory Efficiency**: Important for handling 900MB database

### Why Cytoscape.js?

1. **Performance**: Handles 100+ nodes smoothly with WebGL rendering
2. **Layout Algorithms**: Built-in dagre for hierarchical call graphs
3. **Interactivity**: Rich event system for click/hover/zoom
4. **Maturity**: Well-documented, stable API

### Why BFS with Depth Limit?

The CPG contains ~555K nodes. Rendering everything is impossible. BFS with configurable depth:
- Provides focused, readable subgraphs (10-60 nodes)
- Allows progressive exploration (double-click to expand)
- Prevents overwhelming the user with information

### Trade-offs

| Decision | Benefit | Trade-off |
|----------|---------|-----------|
| Read-only SQLite | Simplicity, safety | No caching layer |
| 60-node limit | Performance, readability | May truncate large call graphs |
| Client-side rendering | Interactivity | Initial load time |
| No SSR for graph | Cytoscape requires DOM | SEO not needed for dev tool |

## API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /api/stats` | Database statistics |
| `GET /api/packages` | List all packages |
| `GET /api/packages/graph` | Package dependency graph |
| `GET /api/packages/:name/functions` | Functions in a package |
| `GET /api/callgraph?id=X&depth=N&direction=callees\|callers` | Call graph for function |
| `GET /api/function/source?id=X` | Source code for function |
| `GET /api/function/metrics?id=X` | Metrics for function |
| `GET /api/function/findings?id=X` | Findings for function |
| `GET /api/source?file=path` | Source code by file path |
| `GET /api/search?q=term` | Search functions/types |
| `GET /api/search/code?q=term` | Full-text search in code |
| `GET /api/hotspots?limit=N` | Top N problematic functions |
| `GET /api/health` | Health check |

## Performance Considerations

1. **Database Optimization**
   - Read-only mode with shared cache
   - Connection pooling (10 connections)
   - Fallback queries when pre-computed tables unavailable

2. **Query Optimization**
   - Indexed lookups by ID
   - LIMIT clauses prevent runaway queries
   - BFS implemented in application code for control

3. **Frontend Optimization**
   - Dynamic import for Cytoscape (code splitting)
   - `useDeferredValue` for non-blocking graph updates
   - `startTransition` for responsive filter changes
   - `requestAnimationFrame` for deferred graph initialization
   - Debounced search (300ms)
   - AbortController for request cancellation

## Schema Tables Used

| Table | Usage |
|-------|-------|
| `nodes` | All graph nodes (functions, types, etc.) |
| `edges` | Call relationships between nodes |
| `sources` | Source file contents |
| `metrics` | Function complexity metrics |
| `findings` | Static analysis findings |
| `dashboard_hotspots` | Pre-computed hotspot rankings |
| `sources_fts` | Full-text search index |

## Future Improvements

With more time, I would add:

1. **Data Flow Visualization**: Trace DFG edges for variable flow analysis
2. **Type Hierarchy View**: Visualize interface implementations
3. **Code Navigation**: Jump-to-definition within source viewer
4. **Graph Caching**: Redis layer for frequently accessed subgraphs
5. **Keyboard Shortcuts**: Vim-style navigation
6. **Export**: PNG/SVG export of current graph view

## Running the Application

```bash
# 1. Generate the CPG database (place in cpg-explorer/data/cpg.db)
./cpg-gen ./prometheus cpg-explorer/data/cpg.db \
  -modules ./client_golang:github.com/prometheus/client_golang:client_golang,\
./prometheus-adapter:sigs.k8s.io/prometheus-adapter:adapter

# 2. Start the application
cd cpg-explorer
docker compose up --build

# 3. Open http://localhost:3000
```

## Evaluation Criteria Coverage

| Criterion | Weight | Implementation |
|-----------|--------|---------------|
| **Graph work** | 25% | Cytoscape.js with dagre layout, interactive nodes, zoom controls, node navigation |
| **Developer utility** | 20% | Call graph exploration, source view, metrics, findings, hotspots, package browser |
| **Engineering quality** | 20% | Clean separation: API/DB/Handlers in Go, Components/Lib in React, TypeScript |
| **Performance** | 15% | 60-node limit, useDeferredValue, startTransition, requestAnimationFrame, connection pooling |
| **Schema exploration** | 10% | Uses nodes, edges, sources, metrics, findings, dashboard_hotspots, sources_fts |
| **UI/UX** | 10% | Dark theme, loading states, toast notifications, responsive panels, zoom controls |
