# CPG Explorer - Solution Write-up

## Overview

CPG Explorer is a web-based IDE for exploring Go codebases through their Code Property Graph. The application provides an interactive graph visualization focused on **Call Graph exploration**, allowing developers to understand function relationships, trace call chains, and view source code.

## Architecture

### Tech Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| **Backend** | Go 1.21 + Gorilla Mux | Native SQLite support, high performance, matches the CPG generator language |
| **Frontend** | Next.js 14 + TypeScript | Modern React framework with SSR, App Router for fast navigation |
| **Graph Viz** | Cytoscape.js + dagre | Mature graph library with excellent performance on 100+ nodes, automatic layout algorithms |
| **Styling** | Tailwind CSS | Rapid UI development, consistent dark theme |
| **Database** | SQLite (read-only) | Directly uses the CPG database generated by cpg-gen |

### System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Browser                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Next.js Frontend (:3000)                │    │
│  │  ┌──────────┐  ┌──────────────┐  ┌─────────────┐    │    │
│  │  │ Sidebar  │  │  GraphView   │  │ SourceView  │    │    │
│  │  │ Packages │  │ (Cytoscape)  │  │  (Prism)    │    │    │
│  │  └──────────┘  └──────────────┘  └─────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/JSON
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Go Backend (:8080)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Handlers   │──│   Queries   │──│  SQLite (cpg.db)    │  │
│  │  REST API   │  │   BFS/DFS   │  │  ~900MB, read-only  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Key Features

### 1. Call Graph Explorer (Primary Feature)

- **BFS Traversal**: Explores function call relationships up to configurable depth (1-5 levels)
- **Bidirectional Navigation**: View both callees (what this function calls) and callers (what calls this function)
- **Interactive Nodes**: Click to select, double-click to navigate into a function's neighborhood
- **Focused Subgraphs**: Limited to 60 nodes per view for performance and readability

### 2. Package Browser

- Hierarchical list of all packages in the codebase
- Expandable to show functions within each package
- Quick filter for package search
- Shows function count per package

### 3. Source Code Viewer

- Syntax-highlighted Go code (via Prism)
- Line highlighting for selected function
- File path and line number display
- Integrated with graph selection

### 4. Global Search

- Fuzzy search across functions, methods, and types
- Real-time results with debouncing
- Direct navigation to search results

## Design Decisions

### Why Go Backend?

1. **Performance**: Direct SQLite access without ORM overhead
2. **Consistency**: Same language as the CPG generator
3. **Simplicity**: Single binary deployment, minimal dependencies
4. **Memory Efficiency**: Important for handling 900MB database

### Why Cytoscape.js?

1. **Performance**: Handles 100+ nodes smoothly with WebGL rendering
2. **Layout Algorithms**: Built-in dagre for hierarchical call graphs
3. **Interactivity**: Rich event system for click/hover/zoom
4. **Maturity**: Well-documented, stable API

### Why BFS with Depth Limit?

The CPG contains ~555K nodes. Rendering everything is impossible. BFS with configurable depth:
- Provides focused, readable subgraphs (10-60 nodes)
- Allows progressive exploration (double-click to expand)
- Prevents overwhelming the user with information

### Trade-offs

| Decision | Benefit | Trade-off |
|----------|---------|-----------|
| Read-only SQLite | Simplicity, safety | No caching layer |
| 60-node limit | Performance, readability | May truncate large call graphs |
| Client-side rendering | Interactivity | Initial load time |
| No SSR for graph | Cytoscape requires DOM | SEO not needed for dev tool |

## API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /api/stats` | Database statistics |
| `GET /api/packages` | List all packages |
| `GET /api/packages/graph` | Package dependency graph |
| `GET /api/packages/:name/functions` | Functions in a package |
| `GET /api/functions/:id/callgraph?depth=N&direction=callees\|callers` | Call graph |
| `GET /api/functions/:id/source` | Source code for function |
| `GET /api/source?file=path` | Source code by file path |
| `GET /api/search?q=term` | Search functions/types |
| `GET /api/health` | Health check |

## Performance Considerations

1. **Database Optimization**
   - Read-only mode with shared cache
   - WAL mode for concurrent reads
   - Connection pooling (10 connections)

2. **Query Optimization**
   - Indexed lookups by ID
   - LIMIT clauses prevent runaway queries
   - BFS implemented in application code for control

3. **Frontend Optimization**
   - Dynamic import for Cytoscape (code splitting)
   - Debounced search (300ms)
   - Minimal re-renders with useCallback

## Future Improvements

With more time, I would add:

1. **Data Flow Visualization**: Trace DFG edges for variable flow analysis
2. **Type Hierarchy View**: Visualize interface implementations
3. **Code Navigation**: Jump-to-definition within source viewer
4. **Graph Caching**: Redis layer for frequently accessed subgraphs
5. **Keyboard Shortcuts**: Vim-style navigation
6. **Export**: PNG/SVG export of current graph view

## Running the Application

```bash
# 1. Generate the CPG database
./cpg-gen ./prometheus cpg-explorer/data/cpg.db \
  -modules ./client_golang:github.com/prometheus/client_golang:client_golang,\
./prometheus-adapter:sigs.k8s.io/prometheus-adapter:adapter

# 2. Start the application
cd cpg-explorer
docker compose up --build

# 3. Open http://localhost:3000
```

## Evaluation Criteria Coverage

| Criterion | Implementation |
|-----------|---------------|
| **Graph work (25%)** | Cytoscape.js with dagre layout, interactive nodes, zoom/pan, legend |
| **Developer utility (20%)** | Call graph exploration, source view, package browser, search |
| **Engineering quality (20%)** | Clean separation: API/DB/Handlers in Go, Components/Lib in React |
| **Performance (15%)** | 60-node limit, connection pooling, debouncing, lazy loading |
| **Schema exploration (10%)** | Uses nodes, edges, sources tables; call edges for graph |
| **UI/UX (10%)** | Dark theme, loading states, error handling, responsive panels |
